#!/bin/sh

[ "$1" = "stop" ] && {
    kill -s TERM "$(pgrep "${0##*/}" | head -n 1)"
    exit 0
}

cleanup() {
    if [ "$pid" ] && kill -0 "$pid" 2> /dev/null; then
        kill -s TERM "$pid"
        wait "$pid"
        r=$?
    fi

    exit "${r:-$?}"
}

tty=$(tty)
tty=${tty#/dev/tty}

trap cleanup EXIT

xrc=$HOME/.xrc

[ -x "$xrc" ] || {
    printf 'Config file "%s" is either missing or not executable.\n' "$xrc"
    exit 1
}

trap 'DISPLAY=:$tty "$xrc"' USR1

(
    trap '' USR1 && exec Xorg :"$tty" \
        -keeptty vt"$tty" \
        -noreset \
        -ardelay 250 \
        -arinterval 25 \
        -nolisten tcp
) & pid=$!

wait "$pid"
