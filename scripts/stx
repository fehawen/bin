#!/bin/sh

cleanup() {
    if [ "$pid" ] && kill -0 "$pid" 2> /dev/null; then
        kill -s TERM "$pid"
        wait "$pid"
        r=$?
    fi

    if ! stty "$stty"; then
        stty sane
    fi

    xauth remove :"$tty"
    exit "${r:-$?}"
}

stty=$(stty -g)
tty=$(tty)
tty=${tty#/dev/tty}

xdir=$HOME/.stx
mkdir -p "$xdir"

export XAUTHORITY=$xdir/xauthority
touch "$XAUTHORITY"

trap cleanup EXIT

xauth add :"$tty" MIT-MAGIC-COOKIE-1 "$(od -An -N16 -tx /dev/urandom | tr -d ' ')"

xrc=$HOME/.xrc

trap 'DISPLAY=:$tty "$xrc"' USR1

(
    trap '' USR1 && exec Xorg :"$tty" \
        -keeptty vt"$tty" \
        -noreset \
        -ardelay 250 \
        -arinterval 25 \
        -nolisten tcp \
        -auth "$XAUTHORITY"
) & pid=$!

wait "$pid"
